<span style="white-space:normal">
<script type="text/javascript">
  function submitUserForm(formID){
    document.getElementById("submit_choose_user").value = "submit_choose_user";
    document.getElementById(formID).submit();
  }
  function setChosenUser(user){
    document.getElementById("chosen_user").value = user;
    document.getElementById("chosen_user_message").innerHTML = "";
  }
</script>
<input type="hidden" name="submit_choose_user" id="submit_choose_user"
       value="" />
<input type="text" name="chosen_user" id="chosen_user" 
         value="<% $chosen_user %>" size="24" maxlength="64" /> 
<a href="javascript:submitUserForm('<% $form_id %>')" >search...</a> 
<span id="chosen_user_message"><% $message %></span>
</span><%args>
 $form_id
 $chosen_user => ''
 $submit_choose_user => ''
</%args><%init>
 my $message;
 if ($submit_choose_user){
   unless ($chosen_user){

     # problem with this is that the refresh changes the sizes
     # of everything ... but I guess I can live with that.
     $message = "<p/> Please enter a name before searching.";

     # problem with approach is that hitting search again is bad.
     ## $chosen_user = " Please enter a name first.";
   }
   else {
     my $users = GenericPerson->find_matches($chosen_user);
     if (scalar @$users == 0){
       $message = "<p/>No matches found for '$chosen_user'.<p />" .
	          'To add someone to the database,<br/>' .
		  'go to the <a href="' . ($ENV{WA_URL} || '')  .
                  '/special/user">user</a> page.';
     }
     else {
       $message = "<p/>results for '$chosen_user':<br/>&nbsp;<br/>";
       for my $user (@$users){
	 my $detail;
	 next unless $user->username;
	 if ($user->is_ldap){
	   my $status = $user->marlboro_status;
	   $detail= $status eq 'student' ? $user->class_standing : $status;
	 }
	 my $name = $user->name;
	 my $username = $user->username;
	 my $both_names = $user->name_username;
	 $message .= 
	    qq{&nbsp; <a href="javascript:setChosenUser('$both_names')">}
	  . qq{$name</a> ($username) $detail <br/>};
       }
       if (scalar @$users > 20){ # Local policy limits anon ldap search to 25.
	 $message .= "<br/>Some results may not be shown;<br/>"
	   . "please narrow your search.<br/>";
       }
     }
   }
}
</%init>
<%doc>
 A text input box that lets the viewer choose a user.
 Call this from within a form in another mason component.

 Input: the id of the enclosing form must be set.

 Output: 

 See course.mhtml, for example, which uses this component.

  <form id="theForm">
   <& $ENV{WA_SRC} . '/scripts/choose_user.mhtml', form_id=>'theForm', %ARGS &>
  </form>
  <%args>
    $chosen_user => ''
  </%args>
  <%init>
    if ($chosen_user eq 'Jim Mahoney (mahoney)'){ ... }
  </%init>

</%doc>
%# $Id: choose_user.mhtml 7 2006-01-13 02:21:11Z mahoney $

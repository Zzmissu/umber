%# Add classes for both of these; see the wiki.
%# Image probably needs some sort of "align center"
% if ($html and $args !~ /img/i ){
<span class="math"><% $html %></span>
% }
% else {
<img src="<% $img_url %>" />
% }
% if (0){   # DEBUG
<div style="border: 2px solid blue">
INFO:<br/>
<pre>
 tex        = "<% $tex %>"
 tex md5    = <% $texmd5hex %>
 tmp_dir    = <% $tmp_dir %>
 png_dir    = <% $png_dir %>
 result     = <% describe($result) %>"
 from cache = <% $from_cache ? 'yes' : 'no' %>
 status     = <% $status %> => <% $status_code{$status} %>
 png md5    = <% $pngmd5 %>
 png url    = <% $img_url %>
 args       = <% describe($args) %>
</pre>
<hr/>
HTML:<br/>
<% $html %>
<hr/>
MATHML:<br/>
<% $mathml %>
<hr/>
PNG:<br/>
<img src="<% $img_url %>" />
</div>
%}
%# ======================================================================
<%args>
 $tex    => ''
 $args   => ''
</%args>
%
<%init>

 my $encoding  = 'utf-8';
 my $png_dir   = $ENV{WA_APACHE_ROOT} . $ENV{WA_MATH_DIR};
 my $tmp_dir   = $png_dir . '/tmp';
 my $png_url   = $ENV{WA_MATH_DIR};
 my $texvc     = $ENV{WA_TEXVC};
 my $GET_CACHE = 1;  # 1 => get from mason cache if available there
 my $SET_CACHE = 1;  # 1 => set mason cache after texvc calculation

 my %status_code = (
  '+'	=> 'ok image only',
   c	=> 'ok conservative HTML',
   m	=> 'ok moderate HTML',
   l	=> 'ok liberal HTML',
   C	=> 'ok conservative HTML with mathml',
   M	=> 'ok moderate HTML with mathml',
   L	=> 'ok liberal HTML with mathml',
   X	=> 'ok with mathml',
   S	=> 'Error in TeX syntax',
   E	=> 'Error in TeX lex parse',
   F	=> 'Unknown function in TeX',
  '-'	=> 'Error in TeX',
 );

 use Digest::MD5 qw(md5_hex);
 my $texmd5hex = md5_hex($tex);
 my ($result, $from_cache);
 $result = $m->cache->get($texmd5hex) if $GET_CACHE;
 if (defined $result){
   $from_cache = 1;
 }
 else {
   $from_cache = 0;
   $result =  `$texvc $tmp_dir $png_dir "$tex" $encoding 2>/dev/null`;
   $m->cache->set($texmd5hex, $result) if $SET_CACHE;  # key => value
 }

 # print "DEBUG result = '$result'\n" if $DEBUG;
 my $status = substr($result, 0, 1);
 my ($pngmd5, $html, $mathml, $img_url);
 if ($status =~ /F/){
   $html = '<span class="matherror">' . $status_code{$status}
    . ' : ' . substr($result,1) .  '</span>';  
   $img_url = '';
 }
 elsif ($status =~ /E/){
   $html = '<span class="matherror">'.$status_code{$status}
     . ' (probably an unrecognized character) ' . '</span>';  
   $img_url = '';
 }
 elsif ($status =~ /S|-/){
   $html = '<span class="matherror">'.$status_code{$status}.'</span>';  
   $img_url = '';
 }
 else {
   substr($result,-1,1) = '' if $result =~ /-$/;  # what is the - at the end ?
   $result =~ m/^ . (.{32}) ([^\0]*) (\0 (.*) )* $/mx;
   #                $1      $2       $3          
   ($pngmd5, $html, $mathml) = ($1 || '', $2 || '', $3 || '');
   if ($status =~ /X/){
     $mathml = $html;
     $html   = '';
   }
   elsif ($status =~ /\+/){
     $mathml = $html = '';
   }
   elsif ($status =~ /S|E|F|-/){
   }
   $img_url = $png_url . '/' . $pngmd5 . '.png';
 }

 # $result =~ m/^ (.)   (.{32}) ([^\0]*) (\0 (.*) )* -? $/mx;
 # #              $1    $2      $3       $4  $5      what is the -?
 # my ($status,$pngmd5,$html,$mathml)=($1 || '', $2 || '', $3 || '', $5 || '');
 # if ($status =~ /X/){
 #   $mathml = $html;
 #   $html   = '';
 # }
 # elsif ($status =~ /\+/){
 #   $mathml = $html = '';
 # }
 # elsif ($status =~ /S|E|F|-/){
 #   $html = $status_code{$status};  # Add some sort of color or error class?
 # }
 # my $img_url = $png_url .'/' . $pngmd5 . '.png';

</%init>
%
<%doc>

 Generate HTML for the text within <math>...</math> tags,
 using the 'texvc' command line utility from MediaWiki, 
 which in turn uses TeX and ImageMagick.

 The environment variables WA_TEXVC, WA_TMP_DIR, and WA_MATH_DIR
 need to be defined, typically from the project's conf/environment.

 This is called from the math_handler routine in Wikiacademia/WikiPlugins.pm
 It's here in a mason component because
   1) that way it can take advantage of HTML::Mason's caching mechanism, and
   2) I've been trying to keep HTML specific stuff within mason.

 ----------------------------------------------------
  $Id: math.mhtml 1694 2006-03-22 15:57:00Z mahoney $
 ----------------------------------------------------
</%doc>

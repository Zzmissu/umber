<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title><% $page->title %></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <!-- Changed by: Jim Mahoney, 03-Mar-2006 -->
  <link rel="icon" type="image/gif" href="<%$images%>/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="<%$styles%>/wikiacademia.css" />
</head>
<body>
<div id="header">                            <!-- start header -->
 <a id="cs-logo" href="/"><img src="<%$images%>/cs_m_edu.png" 
    alt="computer science @ marlboro.edu" /></a>
 <% $HTML{login} %>
</div>                                       <!-- end header -->
<& scripts/actions.mhtml, %ARGS &>
<div id="column-one">                        <!-- start column-one -->
% my $course = $page->course;
%# <h1><a href="<% $course->uri %>"><% $course->title %></a></h1>
 <h1><a href="<% $course->uri %>"><% $course->name_as_title %></a></h1>
 <div><div id="semester"><% $course->semester %></div></div>
 <% $HTML{navigation} %>
 <div>
  <a href="http://www.marlboro.edu"
  ><img id="mc-logo" alt="Marlboro College" src="<%$images%>/mc-logo.gif"/></a>
 </div>
</div>                                       <!-- end column-one -->
<div id="column-two">                        <!-- start column-two -->
 <div class="component"> <!-- start component -->
  <% $page->error ? $m->scomp('scripts/error.mhtml', %ARGS) : '' %>
  <% $HTML{work} %>
  <% $content %>
  <div id="modified">
   <% $HTML{uri_links} %><br />
%  if ($page->lastmodified){
    last modified <% $page->lastmodified %>
%  }
  </div>
 </div>                  <!-- end component -->
 <% $HTML{attachments} %>
 <div class="footer"> 
  <% $HTML{footer} %> 
 </div>
</div>                                       <!-- end column-two -->
%#
%# % if ($session->username eq 'mahoney'){
%#   <& scripts/debug.mhtml, %ARGS &>
%# % }
%#
</body>
</html>
%# ======================================================================
<%args>
  $action    => ''  # e.g. ?action=edit in URL
  $revision  => ''  # if set without action implies &action=view
</%args>
<%flags>
  inherit => undef
</%flags>
<%init>
  my $images = $ENV{WA_SRC} . '/images';
  my $styles = $ENV{WA_SRC} . '/styles';

  # Set the content type regardless of the MIME type of the URI;
  # whatever it is, it'll be embedded in this html page.
  $r->content_type('text/html');

  # Set the default action to 'view' when a revision number is given.
  if ($revision and not $action){
    $action = $ARGS{action} = 'view';
  }

  # Pre-load the HTML for some of the components.
  # Some of the components are loaded here, while others are embedded above.
  # (Note that the order they're evaluated matters, eg actions.mhtml after 
  #  page content so which tabs are visible can be set when the page loads.)
  my %HTML;
  for my $comp qw(login navigation work uri_links attachments footer){
    $HTML{$comp} = $m->scomp('scripts/' . $comp . '.mhtml', %ARGS);
  }

  # Set the page's content to be displayed, and its lastmodified date.
  my $content;
  if ($page->is_directory){
    $content = $m->scomp('scripts/directory.mhtml', %ARGS);
  }
  elsif ($page->directory eq '/special'){
    my $comp = $m->fetch_comp( 'special/' . $page->name . '.mhtml');
    if ($comp){
      $content = $m->scomp( $comp, %ARGS );
    }
    else {
      $content = '';
      $page->error('Oops:"<b>' . $page->name . '</b>" isn\'t a special page.');
    }
  }
  elsif ($action){
    my $comp = $m->fetch_comp( 'actions/' . $action . '.mhtml');
    if ($comp){
      $content = $m->scomp( $comp, %ARGS );
    }
    else {
      $content = '';
      $page->error("Oops: '$action' is not a valid action.");
    }
  }
  elsif ($page->file_exists){
    my $next = $m->fetch_next;
    # $page->lastmodified( last_modified($next) );
    $page->lastmodified( epoch2datetime( $page->epoch_last_modified ));
    my $extension = $page->extension;
    if ($extension eq '.wiki'){              # normal wiki page
      $content = wiki2html($page->text);
    }
    elsif ($extension eq '.html'){           # only if "chmod +x"
      $content = $m->scomp($next);
    }
    else {                                   
      die("Oops : ");                        # no pages get here right now.
      # $content = $page->text;         # ... but this is what it'd be.
    }
  }
  else {
    $content = $m->scomp($m->fetch_next, %ARGS);  # dhandler
  }
</%init>
<%doc>
 $Id: main.mhtml 1694 2006-03-22 15:57:00Z mahoney $

 See Page->is_mason_request for the rules behind which requests get here.

 Note that the globals available here are $page, $m, $r, and $app.
</%doc>
